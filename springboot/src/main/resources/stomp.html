<!DOCTYPE html>
<html>
<head>
    <title>Spring Boot STOMP Chat Test</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .log-box { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; background-color: #f9f9f9; }
        input[type="text"], button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background-color: #4CAF50; color: white; border: none; }
        button:hover { opacity: 0.9; }
        .status { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>STOMP WebSocket í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</h2>

    <label for="jwtToken">JWT í† í°:</label>
    <input type="text" id="jwtToken" placeholder="ì—¬ê¸°ì— ìƒˆë¡œ ë°œê¸‰ë°›ì€ Bearer í† í° ê°’ì„ ì…ë ¥í•˜ì„¸ìš”">

    <label for="roomId">ì±„íŒ…ë°© ID:</label>
    <input type="text" id="roomId" value="1" placeholder="êµ¬ë…í•  ì±„íŒ…ë°© ID">

    <button onclick="connectAndSubscribe()">ì—°ê²° ë° êµ¬ë… ì‹œì‘</button>

    <div class="status">ìƒíƒœ: <span id="statusText" style="color: red;">ì—°ê²° ëŠê¹€</span></div>

    <hr>

    <h3>ë©”ì‹œì§€ ì „ì†¡</h3>
    <input type="text" id="messageInput" placeholder="ë³´ë‚¼ ë©”ì‹œì§€ ì…ë ¥">
    <button onclick="sendMessage()">ë©”ì‹œì§€ ì „ì†¡ (TALK)</button>

    <hr>

    <h3>ìˆ˜ì‹ /ë¡œê·¸</h3>
    <div id="log" class="log-box"></div>
</div>

<script>
    const SOCKET_URL = 'ws://localhost:8081/ws/chat';
    const APP_DESTINATION = '/app/chat/message';
    const TOPIC_DESTINATION = '/topic/chatroom/';

    let stompClient = null;

    function logMessage(message, color = 'black') {
        const log = document.getElementById('log');
        const now = new Date().toLocaleTimeString();
        log.innerHTML += `<div style="color: ${color};">[${now}] ${message}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function updateStatus(text, color) {
        document.getElementById('statusText').textContent = text;
        document.getElementById('statusText').style.color = color;
    }

    function connectAndSubscribe() {
        if (stompClient && stompClient.connected) {
            logMessage('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'orange');
            return;
        }

        const token = document.getElementById('jwtToken').value.trim();
        const roomId = document.getElementById('roomId').value.trim();

        if (!token) {
            logMessage('JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.', 'red');
            return;
        }

        logMessage('WebSocket ì—°ê²° ì‹œë„...', 'blue');

        // 1. Stomp.js í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
        stompClient = new StompJs.Client({
            brokerURL: SOCKET_URL,

            // 2. JWT í† í°ì„ CONNECT í”„ë ˆì„ í—¤ë”ì— ì¶”ê°€
            connectHeaders: {
                'Authorization': `Bearer ${token}`
            },

            reconnectDelay: 5000,
            heartbeatIncoming: 4000,
            heartbeatOutgoing: 4000,
        });

        // ì—°ê²° ì„±ê³µ í•¸ë“¤ëŸ¬
        stompClient.onConnect = (frame) => {
            updateStatus('ì—°ê²°ë¨', 'green');
            logMessage(`STOMP ì—°ê²° ì„±ê³µ: ${frame}`, 'green');

            // 3. ì±„íŒ…ë°© êµ¬ë…
            stompClient.subscribe(TOPIC_DESTINATION + roomId, (message) => {
                logMessage(`[ìˆ˜ì‹ ] ${message.body}`, 'purple');
            });
            logMessage(`í† í”½ êµ¬ë… ì™„ë£Œ: ${TOPIC_DESTINATION}${roomId}`, 'blue');

            // 4. ì…ì¥ ë©”ì‹œì§€ ë°œí–‰ (ì„ íƒ ì‚¬í•­)
            sendEnterMessage(roomId, '1001'); // ğŸ’¡ 'testUser' -> '1001'ë¡œ ìˆ˜ì •
        };

        // ì—°ê²° ëŠê¹€/ì˜¤ë¥˜ í•¸ë“¤ëŸ¬
        stompClient.onWebSocketError = (error) => {
            logMessage(`WebSocket ì—ëŸ¬: ${error}`, 'red');
        };

        stompClient.onStompError = (frame) => {
            updateStatus('STOMP ì˜¤ë¥˜ ë°œìƒ', 'red');
            logMessage(`STOMP ì˜¤ë¥˜: ${frame.headers['message']}`, 'red');
            logMessage(`ìƒì„¸ ë‚´ìš©: ${frame.body}`, 'red');
        };

        stompClient.onDisconnect = () => {
            updateStatus('ì—°ê²° ëŠê¹€', 'red');
            logMessage('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.', 'red');
        };

        stompClient.activate(); // ì—°ê²° í™œì„±í™”
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            logMessage('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.', 'red');
            return;
        }

        const content = document.getElementById('messageInput').value;
        const roomId = document.getElementById('roomId').value;

        const chatMessage = {
            roomId: parseInt(roomId),
            senderId: '1001', // ğŸ’¡ 'testUser' -> '1001'ë¡œ ìˆ˜ì •
            content: content,
            type: 'TALK'
        };

        stompClient.publish({
            destination: APP_DESTINATION,
            body: JSON.stringify(chatMessage),
            headers: { 'content-type': 'application/json' }
        });
        logMessage(`[ë°œí–‰] ${content}`, 'gray');
        document.getElementById('messageInput').value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
    }

    function sendEnterMessage(roomId, senderId) {
        const enterMessage = {
            roomId: parseInt(roomId),
            senderId: senderId,
            type: 'ENTER'
        };

        stompClient.publish({
            destination: APP_DESTINATION,
            body: JSON.stringify(enterMessage),
            headers: { 'content-type': 'application/json' }
        });
        logMessage(`[ë°œí–‰] ì…ì¥ ë©”ì‹œì§€`, 'gray');
    }
</script>

</body>
</html>